<!DOCTYPE html>
<html>
<head>
    <title>Live Voice Chat</title>
</head>
<body>
    <h1>Live Voice Chat with AI</h1>
    <button id="startBtn">Start Talking</button>
    <div id="transcript"></div>
    <div id="aiResponse"></div>

    <script>
        const startBtn = document.getElementById("startBtn");
        const transcriptDiv = document.getElementById("transcript");
        const aiDiv = document.getElementById("aiResponse");

        let ws, audioContext, processor, input;

        startBtn.onclick = async () => {
            ws = new WebSocket("ws://localhost:8000/ws");

            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);

                if (msg.type === "transcript") {
                    transcriptDiv.innerText += "User: " + msg.text + "\n";

                } else if (msg.type === "ai_response") {
                    aiDiv.innerText += msg.text;

                    // Play AI response using browser TTS
                    if ('speechSynthesis' in window) {
                        const utterance = new SpeechSynthesisUtterance(msg.text);
                        speechSynthesis.speak(utterance);
                    }
                }
            };

            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            audioContext = new AudioContext({ sampleRate: 16000 });
            input = audioContext.createMediaStreamSource(stream);

            processor = audioContext.createScriptProcessor(4096, 1, 1);
            processor.onaudioprocess = (e) => {
                const floatData = e.inputBuffer.getChannelData(0);
                const buffer = new ArrayBuffer(floatData.length * 2);
                const view = new DataView(buffer);
                for (let i = 0; i < floatData.length; i++) {
                    let s = Math.max(-1, Math.min(1, floatData[i]));
                    view.setInt16(i * 2, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
                }
                if (ws.readyState === WebSocket.OPEN) {
                    ws.send(buffer);
                }
            };

            input.connect(processor);
            processor.connect(audioContext.destination);
        };
    </script>
</body>
</html>
